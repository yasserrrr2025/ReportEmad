<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج تحويل الطالب للإرشاد الطلابي</title>
    <link rel="stylesheet" href="../assets/styles.css?v=4">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../shared/layout.js?v=3"></script>
    <script src="../shared/storage.js?v=3"></script>
    <script src="../shared/pdf.js?v=6"></script>
    <script src="../shared/ui.js?v=3"></script>
    <style>
        .ref-header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #1e1b4b, #4338ca);
            color: #fff;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(67, 56, 202, .25);
            position: relative;
            overflow: hidden;
        }

        .ref-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40' stroke='rgba(255,255,255,0.05)' stroke-width='2' fill='none'/%3E%3C/svg%3E") repeat;
        }

        .ref-header h2 {
            margin: 0;
            font-size: 21px;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .ref-header p {
            margin: 5px 0 0;
            font-size: 14px;
            opacity: .9;
            position: relative;
            z-index: 1;
        }

        .section-wrap {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #fff;
            overflow: hidden;
        }

        .section-title {
            background: #eef2ff;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 800;
            color: #1e1b4b;
            border-bottom: 1px solid #c7d2fe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
        }

        .grid-label {
            background: #fdfdfd;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .grid-input {
            padding: 4px 8px;
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }

        .grid-input:nth-child(4n) {
            border-left: none;
        }

        .grid-label:nth-last-child(-n+4),
        .grid-input:nth-last-child(-n+4) {
            border-bottom: none;
        }

        .grid-input input,
        .grid-input select {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 13px;
            color: #1e293b;
            background: transparent;
            text-align: right;
        }

        .reason-group {
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .reason-title {
            font-size: 12px;
            font-weight: 800;
            color: #1e1b4b;
            margin-bottom: 8px;
        }

        .checkbox-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chk-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #334155;
            cursor: pointer;
        }

        .chk-item input[type=checkbox] {
            accent-color: #4338ca;
            width: 15px;
            height: 15px;
        }

        .chk-item input[type=radio] {
            accent-color: #4338ca;
        }

        .full-textarea {
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .full-textarea:last-child {
            border-bottom: none;
        }

        .full-textarea .lbl {
            font-size: 12px;
            font-weight: 800;
            color: #1e1b4b;
            margin-bottom: 5px;
        }

        .full-textarea textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            color: #1e293b;
            min-height: 50px;
            line-height: 1.6;
        }

        .counselor-box {
            background: #f5f3ff;
            border: 1px dashed #a5b4fc;
            border-radius: 8px;
            padding: 12px 15px;
            margin: 10px 15px;
        }

        .counselor-box .lbl {
            font-size: 12px;
            font-weight: 800;
            color: #3730a3;
            margin-bottom: 6px;
        }

        .counselor-box textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            color: #1e293b;
            min-height: 50px;
            line-height: 1.6;
            background: transparent;
        }

        .sig-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 15px 20px;
            border-top: 2px dashed #e2e8f0;
        }

        .sig-item {
            text-align: center;
            flex: 1;
        }

        .sig-item-title {
            font-size: 13px;
            font-weight: 800;
            color: #475569;
            margin-bottom: 30px;
        }

        .sig-item input {
            border: none;
            border-bottom: 1px solid #cbd5e1;
            text-align: center;
            width: 80%;
            font-size: 13px;
            font-weight: 700;
            color: #1e293b;
            background: transparent;
            outline: none;
            padding-bottom: 4px;
        }
    </style>
</head>

<body>
    <div class="sheet">
        <div id="appHeader"></div>
        <div class="sheet-content">
            <div class="ref-header">
                <h2>نموذج تحويل الطالب للإرشاد الطلابي</h2>
                <p>استمارة إحالة رسمية من المعلم أو الإدارة إلى الموجه الطلابي</p>
            </div>

            <!-- بيانات الطالب -->
            <div class="section-wrap">
                <div class="section-title"><i class="fa-solid fa-user-graduate"></i> بيانات الطالب</div>
                <div class="grid-layout">
                    <div class="grid-label">اسم الطالب</div>
                    <div class="grid-input"><input type="text" id="rfName" data-save="1" placeholder="رباعي"></div>
                    <div class="grid-label">الصف والفصل</div>
                    <div class="grid-input">
                        <select id="rfGrade" data-save="1"
                            style="flex:2;padding:4px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;">
                            <option value="" disabled selected>الصف</option>
                            <option>الأول متوسط</option>
                            <option>الثاني متوسط</option>
                            <option>الثالث متوسط</option>
                        </select>
                        <span style="margin:0 4px;font-weight:bold;">/</span>
                        <select id="rfSection" data-save="1"
                            style="flex:1;padding:4px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;">
                            <option value="" disabled selected>الفصل</option>
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                            <option>10</option>
                        </select>
                    </div>
                    <div class="grid-label">اسم المُحيل</div>
                    <div class="grid-input"><input type="text" id="rfReferrer" data-save="1"
                            placeholder="اسم المعلم أو الإداري"></div>
                    <div class="grid-label">صفته</div>
                    <div class="grid-input">
                        <select id="rfReferrerRole" data-save="1"
                            style="width:100%;padding:4px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;">
                            <option value="" disabled selected>اختر</option>
                            <option>معلم المادة</option>
                            <option>معلم الفصل</option>
                            <option>وكيل المدرسة</option>
                            <option>مدير المدرسة</option>
                            <option>ولي الأمر</option>
                        </select>
                    </div>
                    <div class="grid-label">تاريخ التحويل</div>
                    <div class="grid-input" style="position:relative">
                        <input type="text" id="rfDateVisual" placeholder="اختر التاريخ..." readonly
                            style="cursor:pointer;width:100%;border:none;outline:none;font-family:inherit;font-size:13px;background:transparent;">
                        <input type="date" id="rfDate" data-save="1"
                            style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;">
                    </div>
                    <div class="grid-label">درجة الأولوية</div>
                    <div class="grid-input">
                        <select id="rfPriority" data-save="1"
                            style="width:100%;padding:4px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;">
                            <option value="" disabled selected>اختر</option>
                            <option>عادية</option>
                            <option>متوسطة</option>
                            <option>عاجلة</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- سبب الإحالة -->
            <div class="section-wrap">
                <div class="section-title"><i class="fa-solid fa-triangle-exclamation"></i> سبب الإحالة</div>
                <div class="reason-group">
                    <div class="reason-title">نوع المشكلة (يمكن اختيار أكثر من واحد):</div>
                    <div class="checkbox-flex">
                        <label class="chk-item"><input type="checkbox" id="rf_r1" data-save="1"> تدني الأداء
                            الأكاديمي</label>
                        <label class="chk-item"><input type="checkbox" id="rf_r2" data-save="1"> الغياب المتكرر</label>
                        <label class="chk-item"><input type="checkbox" id="rf_r3" data-save="1"> مشكلة سلوكية</label>
                        <label class="chk-item"><input type="checkbox" id="rf_r4" data-save="1"> مشكلة نفسية /
                            عاطفية</label>
                        <label class="chk-item"><input type="checkbox" id="rf_r5" data-save="1"> مشكلة اجتماعية</label>
                        <label class="chk-item"><input type="checkbox" id="rf_r6" data-save="1"> ضعف التواصل مع ولي
                            الأمر</label>
                        <label class="chk-item"><input type="checkbox" id="rf_r7" data-save="1"> تنمر أو عنف</label>
                        <label class="chk-item"><input type="checkbox" id="rf_r8" data-save="1"> أخرى</label>
                    </div>
                </div>
                <div class="full-textarea">
                    <div class="lbl">وصف تفصيلي للمشكلة:</div>
                    <textarea id="rfDescription" data-save="1"
                        placeholder="اشرح الموقف أو المشكلة بدقة وتفصيل..."></textarea>
                </div>
                <div class="full-textarea">
                    <div class="lbl">الإجراءات التي اتُّخذت قبل الإحالة:</div>
                    <textarea id="rfPrevActions" data-save="1"
                        placeholder="ماذا جرّبت قبل إحالة الطالب للموجه؟ (نصيحة، تواصل مع ولي الأمر، تنبيه...)"></textarea>
                </div>
            </div>

            <!-- استجابة الموجه الطلابي -->
            <div class="section-wrap">
                <div class="section-title"><i class="fa-solid fa-headset"></i> استجابة الموجه الطلابي — للاستخدام الرسمي
                </div>
                <div class="counselor-box">
                    <div class="lbl">خطة التدخل والإجراءات المتبعة:</div>
                    <textarea id="rfCounselorPlan" data-save="1"
                        placeholder="يكتبها الموجه الطلابي بعد مقابلة الطالب..."></textarea>
                </div>
                <div class="full-textarea" style="display:flex;align-items:center;gap:15px;">
                    <div class="lbl" style="white-space:nowrap;">نتيجة التدخل:</div>
                    <div class="checkbox-flex">
                        <label class="chk-item"><input type="radio" name="rfOutcome" id="rfOut1" data-save="1"> تم
                            الحل</label>
                        <label class="chk-item"><input type="radio" name="rfOutcome" id="rfOut2" data-save="1"> قيد
                            المتابعة</label>
                        <label class="chk-item"><input type="radio" name="rfOutcome" id="rfOut3" data-save="1"> تحويل
                            لجهة أعلى</label>
                    </div>
                </div>
            </div>

            <!-- التوقيعات -->
            <div class="sig-container">
                <div class="sig-item">
                    <div class="sig-item-title">المُحيل</div><input type="text" id="rfSigRef" data-save="1"
                        placeholder="الاسم والتوقيع">
                </div>
                <div class="sig-item">
                    <div class="sig-item-title">الموجه الطلابي</div><input type="text" id="rfSigCounselor" data-save="1"
                        placeholder="الاسم والتوقيع">
                </div>
                <div class="sig-item">
                    <div class="sig-item-title">مدير المدرسة</div><input type="text" id="rfSigManager" data-save="1"
                        placeholder="عابد عبيد الجدعاني">
                </div>
            </div>
        </div>
        <div id="appFooter"></div>
    </div>
    <script>
        window.currentPageKey = 'storage_student_referral_v1';
        document.addEventListener('DOMContentLoaded', () => {
            window.appStorage.restorePage(window.currentPageKey);
            var daysAr = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            function formatDateAr(v) {
                if (!v) return ''; var d = new Date(v); if (isNaN(d)) return '';
                return daysAr[d.getDay()] + ' - ' + d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
            }
            var h = document.getElementById('rfDate'), v = document.getElementById('rfDateVisual');
            if (h && v) {
                if (h.value) v.value = formatDateAr(h.value);
                h.addEventListener('change', function () { v.value = formatDateAr(h.value); if (window.appStorage && window.appStorage.savePage) window.appStorage.savePage(window.currentPageKey); });
            }
            window.appStorage.setupAutoSave(window.currentPageKey);
        });
    </script>
</body>

</html>
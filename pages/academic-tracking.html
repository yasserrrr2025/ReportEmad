<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج متابعة الطالب الأكاديمية</title>
    <link rel="stylesheet" href="../assets/styles.css?v=4">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../shared/layout.js?v=3"></script>
    <script src="../shared/storage.js?v=3"></script>
    <script src="../shared/pdf.js?v=6"></script>
    <script src="../shared/ui.js?v=3"></script>
    <style>
        .track-header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #78350f, #d97706);
            color: #fff;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(217, 119, 6, .25);
            position: relative;
            overflow: hidden;
        }

        .track-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40' stroke='rgba(255,255,255,0.05)' stroke-width='2' fill='none'/%3E%3C/svg%3E") repeat;
        }

        .track-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .track-header p {
            margin: 5px 0 0;
            font-size: 14px;
            opacity: .9;
            position: relative;
            z-index: 1;
        }

        .section-wrap {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 15px;
            background: #fff;
            overflow: hidden;
        }

        .section-title {
            background: #fffbeb;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: 800;
            color: #78350f;
            border-bottom: 1px solid #fde68a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
        }

        .grid-label {
            background: #fdfdfd;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .grid-input {
            padding: 4px 8px;
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }

        .grid-input:nth-child(4n) {
            border-left: none;
        }

        .grid-label:nth-last-child(-n+4),
        .grid-input:nth-last-child(-n+4) {
            border-bottom: none;
        }

        .grid-input input,
        .grid-input select {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 13px;
            color: #1e293b;
            background: transparent;
            text-align: right;
        }

        .grades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .grades-table th {
            background: #fef3c7;
            padding: 8px 10px;
            font-weight: 800;
            color: #78350f;
            border: 1px solid #fde68a;
            text-align: center;
        }

        .grades-table td {
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            vertical-align: middle;
            text-align: center;
        }

        .grades-table input {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 13px;
            color: #1e293b;
            background: transparent;
            text-align: center;
        }

        .grades-table tr:nth-child(even) td {
            background: #fafafa;
        }

        .grade-low {
            color: #dc2626 !important;
            font-weight: 800;
        }

        .grade-ok {
            color: #16a34a !important;
            font-weight: 800;
        }

        .abs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .abs-table th {
            background: #fef3c7;
            padding: 7px 10px;
            font-weight: 800;
            color: #78350f;
            border: 1px solid #fde68a;
        }

        .abs-table td {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .abs-table input {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 13px;
            color: #1e293b;
            background: transparent;
            text-align: center;
        }

        .full-textarea {
            padding: 10px;
        }

        .full-textarea textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            color: #1e293b;
            min-height: 50px;
            line-height: 1.6;
        }

        .sig-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 15px 20px;
            border-top: 2px dashed #e2e8f0;
        }

        .sig-item {
            text-align: center;
            flex: 1;
        }

        .sig-item-title {
            font-size: 13px;
            font-weight: 800;
            color: #475569;
            margin-bottom: 30px;
        }

        .sig-item input {
            border: none;
            border-bottom: 1px solid #cbd5e1;
            text-align: center;
            width: 80%;
            font-size: 13px;
            font-weight: 700;
            color: #1e293b;
            background: transparent;
            outline: none;
            padding-bottom: 4px;
        }
    </style>
</head>

<body>
    <div class="sheet">
        <div id="appHeader"></div>
        <div class="sheet-content">
            <div class="track-header">
                <h2>نموذج متابعة الطالب الأكاديمية</h2>
                <p>تقرير دوري لرصد الأداء الدراسي والغيابات والتوصيات</p>
            </div>

            <!-- بيانات الطالب -->
            <div class="section-wrap">
                <div class="section-title"><i class="fa-solid fa-user-graduate"></i> بيانات الطالب</div>
                <div class="grid-layout">
                    <div class="grid-label">اسم الطالب</div>
                    <div class="grid-input"><input type="text" id="atName" data-save="1" placeholder="رباعي"></div>
                    <div class="grid-label">الفصل / الصف</div>
                    <div class="grid-input">
                        <select id="atGrade" data-save="1"
                            style="flex:2;padding:4px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;">
                            <option value="" disabled selected>الصف</option>
                            <option>الأول متوسط</option>
                            <option>الثاني متوسط</option>
                            <option>الثالث متوسط</option>
                        </select>
                        <span style="margin:0 4px;font-weight:bold;">/</span>
                        <select id="atSection" data-save="1"
                            style="flex:1;padding:4px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;">
                            <option value="" disabled selected>الفصل</option>
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                            <option>10</option>
                        </select>
                    </div>
                    <div class="grid-label">الفترة الزمنية</div>
                    <div class="grid-input">
                        <select id="atPeriod" data-save="1"
                            style="width:100%;padding:4px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;">
                            <option value="" disabled selected>اختر</option>
                            <option>الشهر الأول</option>
                            <option>الشهر الثاني</option>
                            <option>الشهر الثالث</option>
                            <option>الفصل الدراسي الأول</option>
                            <option>الفصل الدراسي الثاني</option>
                        </select>
                    </div>
                    <div class="grid-label">العام الدراسي</div>
                    <div class="grid-input"><input type="text" id="atYear" data-save="1" placeholder="1446 - 1447 هـ">
                    </div>
                </div>
            </div>

            <!-- الدرجات -->
            <div class="section-wrap">
                <div class="section-title"><i class="fa-solid fa-chart-simple"></i> رصد الدرجات</div>
                <div style="padding:10px;overflow-x:auto;">
                    <table class="grades-table">
                        <thead>
                            <tr>
                                <th>المادة</th>
                                <th>الدرجة الكاملة</th>
                                <th>درجة الطالب</th>
                                <th>النسبة %</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>القرآن الكريم</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g1" data-save="1" placeholder="-"></td>
                                <td id="gp1">-</td>
                                <td id="gs1">-</td>
                            </tr>
                            <tr>
                                <td>التوحيد</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g2" data-save="1" placeholder="-"></td>
                                <td id="gp2">-</td>
                                <td id="gs2">-</td>
                            </tr>
                            <tr>
                                <td>اللغة العربية</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g3" data-save="1" placeholder="-"></td>
                                <td id="gp3">-</td>
                                <td id="gs3">-</td>
                            </tr>
                            <tr>
                                <td>اللغة الإنجليزية</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g4" data-save="1" placeholder="-"></td>
                                <td id="gp4">-</td>
                                <td id="gs4">-</td>
                            </tr>
                            <tr>
                                <td>الرياضيات</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g5" data-save="1" placeholder="-"></td>
                                <td id="gp5">-</td>
                                <td id="gs5">-</td>
                            </tr>
                            <tr>
                                <td>العلوم</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g6" data-save="1" placeholder="-"></td>
                                <td id="gp6">-</td>
                                <td id="gs6">-</td>
                            </tr>
                            <tr>
                                <td>الاجتماعيات</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g7" data-save="1" placeholder="-"></td>
                                <td id="gp7">-</td>
                                <td id="gs7">-</td>
                            </tr>
                            <tr>
                                <td>الحاسب والتقنية</td>
                                <td style="color:#64748b;">100</td>
                                <td><input type="text" id="g8" data-save="1" placeholder="-"></td>
                                <td id="gp8">-</td>
                                <td id="gs8">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- الغيابات -->
            <div class="section-wrap">
                <div class="section-title"><i class="fa-solid fa-calendar-xmark"></i> سجل الغيابات</div>
                <div style="padding:10px;overflow-x:auto;">
                    <table class="abs-table">
                        <thead>
                            <tr>
                                <th>إجمالي أيام الدراسة</th>
                                <th>الغيابات بعذر</th>
                                <th>الغيابات بدون عذر</th>
                                <th>إجمالي الغيابات</th>
                                <th>نسبة الحضور %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" id="abTotal" data-save="1" placeholder="0"></td>
                                <td><input type="text" id="abExcused" data-save="1" placeholder="0"></td>
                                <td><input type="text" id="abUnexcused" data-save="1" placeholder="0"></td>
                                <td id="abSum">-</td>
                                <td id="abRate">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- الملاحظات والتوصيات -->
            <div class="section-wrap">
                <div class="section-title"><i class="fa-solid fa-pen-to-square"></i> الملاحظات والتوصيات</div>
                <div class="full-textarea">
                    <div style="font-size:12px;font-weight:bold;color:#78350f;margin-bottom:5px;">ملاحظات المعلم على
                        أداء الطالب:</div>
                    <textarea id="atTeacherNote" data-save="1"
                        placeholder="نقاط القوة، نقاط الضعف، السلوك العام..."></textarea>
                </div>
                <div class="full-textarea" style="border-top:1px solid #e2e8f0;">
                    <div style="font-size:12px;font-weight:bold;color:#78350f;margin-bottom:5px;">التوصيات والإجراءات
                        المقترحة:</div>
                    <textarea id="atRecommend" data-save="1"
                        placeholder="الخطة العلاجية، التواصل مع ولي الأمر، التحويل للإرشاد..."></textarea>
                </div>
            </div>

            <!-- التوقيعات -->
            <div class="sig-container">
                <div class="sig-item">
                    <div class="sig-item-title">معلم الفصل / المادة</div><input type="text" id="atSigTeacher"
                        data-save="1" placeholder="الاسم والتوقيع">
                </div>
                <div class="sig-item">
                    <div class="sig-item-title">الموجه الطلابي</div><input type="text" id="atSigCounselor" data-save="1"
                        placeholder="الاسم والتوقيع">
                </div>
                <div class="sig-item">
                    <div class="sig-item-title">مدير المدرسة</div><input type="text" id="atSigManager" data-save="1"
                        placeholder="عابد عبيد الجدعاني">
                </div>
            </div>
        </div>
        <div id="appFooter"></div>
    </div>
    <script>
        window.currentPageKey = 'storage_academic_track_v1';
        document.addEventListener('DOMContentLoaded', () => {
            window.appStorage.restorePage(window.currentPageKey);

            // Auto-calculate grade percentages
            for (var i = 1; i <= 8; i++) {
                (function (idx) {
                    var el = document.getElementById('g' + idx);
                    if (!el) return;
                    el.addEventListener('input', function () { calcGrade(idx); });
                    calcGrade(idx);
                })(i);
            }
            function calcGrade(idx) {
                var el = document.getElementById('g' + idx);
                var pEl = document.getElementById('gp' + idx);
                var sEl = document.getElementById('gs' + idx);
                if (!el || !pEl || !sEl) return;
                var v = parseFloat(el.value);
                if (isNaN(v)) { pEl.textContent = '-'; sEl.textContent = '-'; sEl.className = ''; return; }
                var pct = Math.round(v);
                pEl.textContent = pct + '%';
                if (pct >= 90) { sEl.textContent = 'ممتاز'; sEl.className = 'grade-ok'; }
                else if (pct >= 75) { sEl.textContent = 'جيد جداً'; sEl.className = 'grade-ok'; }
                else if (pct >= 60) { sEl.textContent = 'جيد'; sEl.className = ''; }
                else { sEl.textContent = 'راسب'; sEl.className = 'grade-low'; }
            }

            // Absence calc
            ['abExcused', 'abUnexcused', 'abTotal'].forEach(function (id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('input', calcAbs);
            });
            function calcAbs() {
                var total = parseFloat(document.getElementById('abTotal').value) || 0;
                var exc = parseFloat(document.getElementById('abExcused').value) || 0;
                var unexc = parseFloat(document.getElementById('abUnexcused').value) || 0;
                var sum = exc + unexc;
                document.getElementById('abSum').textContent = sum;
                document.getElementById('abRate').textContent = total > 0 ? Math.round(((total - sum) / total) * 100) + '%' : '-';
            }

            window.appStorage.setupAutoSave(window.currentPageKey);
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج متابعة الطالب الأكاديمية</title>
    <link rel="stylesheet" href="../assets/styles.css?v=4">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../shared/layout.js?v=4"></script>
    <script src="../shared/storage.js?v=3"></script>
    <script src="../shared/pdf.js?v=6"></script>
    <script src="../shared/ui.js?v=3"></script>
    <style>
        .track-header {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #78350f, #d97706);
            color: #fff;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(217, 119, 6, .25);
            position: relative;
            overflow: hidden;
        }

        .track-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40' stroke='rgba(255,255,255,0.05)' stroke-width='2' fill='none'/%3E%3C/svg%3E") repeat;
        }

        .track-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .track-header p {
            margin: 4px 0 0;
            font-size: 13px;
            opacity: .9;
            position: relative;
            z-index: 1;
        }

        .section-wrap {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #fff;
            overflow: hidden;
        }

        .section-title {
            background: #fffbeb;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 800;
            color: #78350f;
            border-bottom: 1px solid #fde68a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .section-title-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
        }

        .grid-label {
            background: #fdfdfd;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .grid-input {
            padding: 3px 7px;
            border-bottom: 1px solid #e2e8f0;
            border-left: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
        }

        .grid-input:nth-child(4n) {
            border-left: none;
        }

        .grid-label:nth-last-child(-n+4),
        .grid-input:nth-last-child(-n+4) {
            border-bottom: none;
        }

        .grid-input input,
        .grid-input select {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 12px;
            color: #1e293b;
            background: transparent;
            text-align: right;
        }

        /* Grades Table */
        .grades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .grades-table th {
            background: #fef3c7;
            padding: 6px 8px;
            font-weight: 800;
            color: #78350f;
            border: 1px solid #fde68a;
            text-align: center;
        }

        .grades-table td {
            padding: 0;
            border: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .grades-table td input {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 12px;
            color: #1e293b;
            background: transparent;
            text-align: center;
            padding: 5px 4px;
        }

        .grades-table td input.subject-input {
            text-align: right;
            padding-right: 8px;
        }

        .grades-table tr:nth-child(even) td {
            background: #fffdf5;
        }

        .grade-low {
            color: #dc2626 !important;
            font-weight: 800;
        }

        .grade-ok {
            color: #16a34a !important;
            font-weight: 800;
        }

        .grade-mid {
            color: #d97706 !important;
            font-weight: 800;
        }

        .grade-result {
            text-align: center;
            padding: 5px 4px;
            font-weight: 800;
            font-size: 11px;
        }

        .del-row-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 14px;
            padding: 3px 6px;
            line-height: 1;
        }

        .del-row-btn:hover {
            background: #fef2f2;
            border-radius: 4px;
        }

        /* Absence Table */
        .abs-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .abs-table th {
            background: #fef3c7;
            padding: 6px 8px;
            font-weight: 800;
            color: #78350f;
            border: 1px solid #fde68a;
            text-align: center;
        }

        .abs-table td {
            padding: 0;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .abs-table input {
            width: 100%;
            border: none;
            outline: none;
            font-family: inherit;
            font-size: 12px;
            color: #1e293b;
            background: transparent;
            text-align: center;
            padding: 5px 4px;
        }

        .abs-total {
            font-weight: 800;
            color: #1e293b;
            padding: 5px 4px;
        }

        /* Add row button */
        .add-row-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #d97706;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            font-family: inherit;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            margin: 6px;
        }

        .add-row-btn:hover {
            background: #b45309;
        }

        /* Notes */
        .note-area {
            padding: 8px 12px;
        }

        .note-label {
            font-size: 11px;
            font-weight: 800;
            color: #78350f;
            margin-bottom: 4px;
        }

        .note-area textarea {
            width: 100%;
            border: none;
            outline: none;
            resize: none;
            font-family: inherit;
            font-size: 12px;
            color: #1e293b;
            min-height: 40px;
            line-height: 1.5;
        }

        /* Signatures */
        .sig-container {
            display: flex;
            justify-content: space-between;
            padding: 12px 20px;
            border-top: 2px dashed #e2e8f0;
        }

        .sig-item {
            text-align: center;
            flex: 1;
        }

        .sig-item-title {
            font-size: 12px;
            font-weight: 800;
            color: #475569;
            margin-bottom: 25px;
        }

        .sig-item input {
            border: none;
            border-bottom: 1px solid #cbd5e1;
            text-align: center;
            width: 80%;
            font-size: 12px;
            font-weight: 700;
            color: #1e293b;
            background: transparent;
            outline: none;
            padding-bottom: 3px;
        }

        @media print {

            .noprint,
            .header-actions-bar {
                display: none !important;
            }

            body {
                background: white;
            }

            .sheet {
                box-shadow: none;
            }
        }
    </style>
</head>

<body>
    <div class="sheet">
        <div id="appHeader"></div>
        <div class="sheet-content">
            <div class="track-header">
                <h2>نموذج متابعة الطالب الأكاديمية</h2>
                <p>تقرير دوري لرصد الأداء الدراسي والغيابات والتوصيات</p>
            </div>

            <!-- بيانات الطالب -->
            <div class="section-wrap">
                <div class="section-title">
                    <div class="section-title-left"><i class="fa-solid fa-user-graduate"></i> بيانات الطالب</div>
                </div>
                <div class="grid-layout">
                    <div class="grid-label">اسم الطالب</div>
                    <div class="grid-input"><input type="text" id="atName" data-save="1" placeholder="رباعي"></div>
                    <div class="grid-label">الصف / الفصل</div>
                    <div class="grid-input">
                        <select id="atGrade" data-save="1"
                            style="flex:2;padding:3px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;font-size:12px;">
                            <option value="" disabled selected>الصف</option>
                            <option>الأول متوسط</option>
                            <option>الثاني متوسط</option>
                            <option>الثالث متوسط</option>
                        </select>
                        <span style="margin:0 3px;font-weight:bold;">/</span>
                        <select id="atSection" data-save="1"
                            style="flex:1;padding:3px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;font-size:12px;">
                            <option value="" disabled selected>الفصل</option>
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                            <option>10</option>
                        </select>
                    </div>
                    <div class="grid-label">الفترة الزمنية</div>
                    <div class="grid-input">
                        <select id="atPeriod" data-save="1"
                            style="width:100%;padding:3px;border:1px solid #e2e8f0;border-radius:4px;font-weight:bold;color:#1e293b;font-size:12px;">
                            <option value="" disabled selected>اختر</option>
                            <option>الشهر الأول</option>
                            <option>الشهر الثاني</option>
                            <option>الشهر الثالث</option>
                            <option>الفصل الدراسي الأول</option>
                            <option>الفصل الدراسي الثاني</option>
                        </select>
                    </div>
                    <div class="grid-label">العام الدراسي</div>
                    <div class="grid-input"><input type="text" id="atYear" data-save="1" placeholder="1446 - 1447 هـ">
                    </div>
                </div>
            </div>

            <!-- رصد الدرجات -->
            <div class="section-wrap">
                <div class="section-title">
                    <div class="section-title-left"><i class="fa-solid fa-chart-simple"></i> رصد الدرجات</div>
                    <button class="add-row-btn noprint" onclick="addSubjectRow()"><i class="fa-solid fa-plus"></i> إضافة
                        مادة</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="grades-table">
                        <thead>
                            <tr>
                                <th style="width:30%;">المادة</th>
                                <th style="width:12%;">الدرجة الكاملة</th>
                                <th style="width:12%;">درجة الطالب</th>
                                <th style="width:10%;">النسبة %</th>
                                <th style="width:10%;">الحالة</th>
                                <th class="noprint" style="width:6%;"></th>
                            </tr>
                        </thead>
                        <tbody id="gradesBody">
                            <!-- rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- سجل الغيابات -->
            <div class="section-wrap">
                <div class="section-title">
                    <div class="section-title-left"><i class="fa-solid fa-calendar-xmark"></i> سجل الغيابات</div>
                </div>
                <div style="overflow-x:auto;padding:6px;">
                    <table class="abs-table">
                        <thead>
                            <tr>
                                <th>إجمالي أيام الدراسة</th>
                                <th>الغيابات بعذر</th>
                                <th>الغيابات بدون عذر</th>
                                <th>إجمالي الغيابات</th>
                                <th>نسبة الحضور %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="number" id="abTotal" data-save="1" placeholder="0" oninput="calcAbs()">
                                </td>
                                <td><input type="number" id="abExcused" data-save="1" placeholder="0"
                                        oninput="calcAbs()"></td>
                                <td><input type="number" id="abUnexcused" data-save="1" placeholder="0"
                                        oninput="calcAbs()"></td>
                                <td class="abs-total" id="abSum">-</td>
                                <td class="abs-total" id="abRate">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- الملاحظات -->
            <div class="section-wrap">
                <div class="section-title">
                    <div class="section-title-left"><i class="fa-solid fa-pen-to-square"></i> الملاحظات والتوصيات</div>
                </div>
                <div class="note-area">
                    <div class="note-label">ملاحظات المعلم:</div>
                    <textarea id="atTeacherNote" data-save="1"
                        placeholder="نقاط القوة، نقاط الضعف، السلوك العام..."></textarea>
                </div>
                <div class="note-area" style="border-top:1px solid #e2e8f0;">
                    <div class="note-label">التوصيات والإجراءات المقترحة:</div>
                    <textarea id="atRecommend" data-save="1"
                        placeholder="الخطة العلاجية، تواصل ولي الأمر، التحويل للإرشاد..."></textarea>
                </div>
            </div>

            <!-- التوقيعات -->
            <div class="sig-container">
                <div class="sig-item">
                    <div class="sig-item-title">معلم الفصل / المادة</div><input type="text" id="atSigTeacher"
                        data-save="1" placeholder="الاسم والتوقيع">
                </div>
                <div class="sig-item">
                    <div class="sig-item-title">الموجه الطلابي</div><input type="text" id="atSigCounselor" data-save="1"
                        placeholder="الاسم والتوقيع">
                </div>
                <div class="sig-item">
                    <div class="sig-item-title">مدير المدرسة</div><input type="text" id="atSigManager" data-save="1"
                        placeholder="عابد عبيد الجدعاني">
                </div>
            </div>
        </div>
        <div id="appFooter"></div>
    </div>

    <script>
        window.currentPageKey = 'storage_academic_track_v2';

        var defaultSubjects = [
            'القرآن الكريم', 'التوحيد', 'اللغة العربية', 'اللغة الإنجليزية',
            'الرياضيات', 'العلوم', 'الاجتماعيات', 'الحاسب والتقنية'
        ];

        var subjectsData = []; // [{name, max, score}]

        function loadSubjectsFromStorage() {
            try {
                var s = localStorage.getItem(window.currentPageKey + '_subjects');
                if (s) return JSON.parse(s);
            } catch (e) { }
            return null;
        }

        function saveSubjectsToStorage() {
            // collect current table values
            var rows = document.querySelectorAll('#gradesBody tr');
            var data = [];
            rows.forEach(function (tr) {
                var nameEl = tr.querySelector('.subject-input');
                var maxEl = tr.querySelector('.max-input');
                var scoreEl = tr.querySelector('.score-input');
                data.push({
                    name: nameEl ? nameEl.value : '',
                    max: maxEl ? maxEl.value : '100',
                    score: scoreEl ? scoreEl.value : ''
                });
            });
            subjectsData = data;
            localStorage.setItem(window.currentPageKey + '_subjects', JSON.stringify(data));
        }

        function calcGradeStatus(score, max) {
            var s = parseFloat(score), m = parseFloat(max) || 100;
            if (isNaN(s)) return { pct: '-', label: '-', cls: '' };
            var pct = Math.round((s / m) * 100);
            var label, cls;
            if (pct >= 90) { label = 'ممتاز'; cls = 'grade-ok'; }
            else if (pct >= 75) { label = 'جيد جداً'; cls = 'grade-ok'; }
            else if (pct >= 60) { label = 'جيد'; cls = 'grade-mid'; }
            else { label = 'راسب'; cls = 'grade-low'; }
            return { pct: pct + '%', label: label, cls: cls };
        }

        function updateRowCalc(tr) {
            var maxEl = tr.querySelector('.max-input');
            var scoreEl = tr.querySelector('.score-input');
            var pctTd = tr.querySelector('.pct-cell');
            var statuTd = tr.querySelector('.status-cell');
            if (!maxEl || !scoreEl || !pctTd || !statuTd) return;
            var r = calcGradeStatus(scoreEl.value, maxEl.value);
            pctTd.textContent = r.pct;
            statuTd.textContent = r.label;
            statuTd.className = 'grade-result status-cell ' + r.cls;
        }

        function buildRow(idx, name, max, score) {
            var tr = document.createElement('tr');
            tr.dataset.idx = idx;
            tr.innerHTML =
                '<td><input class="subject-input" type="text" placeholder="اسم المادة..." value="' + escHtml(name || '') + '" oninput="saveSubjectsToStorage()"></td>' +
                '<td><input class="max-input" type="number" value="' + escHtml(max || '100') + '" min="1" oninput="updateRowCalc(this.closest(\'tr\'));saveSubjectsToStorage()"></td>' +
                '<td><input class="score-input" type="number" placeholder="-" value="' + escHtml(score || '') + '" oninput="updateRowCalc(this.closest(\'tr\'));saveSubjectsToStorage()"></td>' +
                '<td class="grade-result pct-cell">-</td>' +
                '<td class="grade-result status-cell">-</td>' +
                '<td class="noprint" style="text-align:center;"><button class="del-row-btn" onclick="deleteRow(this)" title="حذف">✕</button></td>';
            return tr;
        }

        function escHtml(s) {
            return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function renderGradesTable(data) {
            var tbody = document.getElementById('gradesBody');
            tbody.innerHTML = '';
            data.forEach(function (d, i) {
                var tr = buildRow(i, d.name, d.max, d.score);
                tbody.appendChild(tr);
                updateRowCalc(tr);
            });
        }

        function addSubjectRow() {
            var tbody = document.getElementById('gradesBody');
            var idx = tbody.querySelectorAll('tr').length;
            var tr = buildRow(idx, '', '100', '');
            tbody.appendChild(tr);
            saveSubjectsToStorage();
            tr.querySelector('.subject-input').focus();
        }

        function deleteRow(btn) {
            var tbody = document.getElementById('gradesBody');
            if (tbody.querySelectorAll('tr').length <= 1) return;
            btn.closest('tr').remove();
            saveSubjectsToStorage();
        }

        function calcAbs() {
            var total = parseFloat(document.getElementById('abTotal').value) || 0;
            var exc = parseFloat(document.getElementById('abExcused').value) || 0;
            var unexc = parseFloat(document.getElementById('abUnexcused').value) || 0;
            var sum = exc + unexc;
            document.getElementById('abSum').textContent = sum || '-';
            document.getElementById('abRate').textContent = total > 0 ? Math.round(((total - sum) / total) * 100) + '%' : '-';
        }

        document.addEventListener('DOMContentLoaded', function () {
            window.appStorage.restorePage(window.currentPageKey);

            var saved = loadSubjectsFromStorage();
            if (saved && saved.length) {
                renderGradesTable(saved);
            } else {
                renderGradesTable(defaultSubjects.map(function (n) { return { name: n, max: '100', score: '' }; }));
            }

            calcAbs();
            window.appStorage.setupAutoSave(window.currentPageKey);
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استمارة الزيارات التبادلية</title>
    <link rel="stylesheet" href="../assets/styles.css">

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Shared Scripts -->
    <script src="../shared/layout.js"></script>
    <script src="../shared/storage.js"></script>
    <script src="../shared/pdf.js"></script>
    <script src="../shared/ui.js"></script>

    <style>
        /* Modern Base Styles for the Visit Form */
        :root {
            --visit-green: #2fa17b;
            --visit-text: #2b3e50;
            --visit-border: #a3e4d7;
            --visit-light: #f8f9f9;
        }

        .visit-container {
            font-family: 'Tajawal', sans-serif;
            color: var(--visit-text);
            padding: 10px;
        }

        /* Top Title Badge */
        .visit-main-title {
            background-color: #2b3e50;
            color: white;
            text-align: center;
            font-size: 20px;
            font-weight: 800;
            padding: 10px 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: fit-content;
            margin: 0 auto 30px auto;
            /* Fixes right-side overflow by perfectly centering via auto margins */
        }

        /* Custom Box (Fieldset Design) */
        .dv-box {
            position: relative;
            border: 2px solid var(--visit-border);
            border-radius: 12px;
            padding: 20px 15px 10px 15px;
            margin-bottom: 25px;
            background-color: white;
        }

        .dv-box-title {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 15px;
            color: var(--visit-green);
            font-weight: 800;
            font-size: 15px;
            white-space: nowrap;
        }

        /* Fix default sheet height overflow */
        .sheet {
            height: auto !important;
            min-height: 297mm;
            padding-bottom: 25mm !important;
        }

        /* Flex Rows for Inputs */
        .dv-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .dv-col {
            flex: 1;
            position: relative;
            border: 2px solid var(--visit-border);
            border-radius: 12px;
            padding: 10px 10px;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .dv-col-title {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 10px;
            color: var(--visit-green);
            font-weight: 800;
            font-size: 14px;
            white-space: nowrap;
        }

        /* Form Inputs */
        .dv-input {
            width: 100%;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            color: var(--visit-text);
            text-align: center;
            outline: none;
        }

        .dv-input::placeholder {
            color: #95a5a6;
            opacity: 0.5;
            font-weight: normal;
        }

        .dv-hint {
            font-size: 10px;
            color: #95a5a6;
            text-align: center;
            width: 100%;
            margin-top: 5px;
            line-height: 1.4;
        }

        /* Select element styling for lists */
        .dv-select {
            width: 100%;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 16px;
            font-weight: 800;
            color: var(--visit-text);
            text-align: center;
            text-align-last: center;
            /* Forces centered text in selects */
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .dv-select-wrapper {
            width: 100%;
            position: relative;
            display: flex;
            justify-content: center;
        }

        /* Evaluation Table Elements */
        .eval-section {
            margin-bottom: 12px;
            border-bottom: 1px dashed #e5e7eb;
            padding-bottom: 10px;
        }

        .eval-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .eval-title {
            font-weight: 800;
            font-size: 15px;
            margin-bottom: 8px;
            color: #1e293b;
            padding-right: 5px;
        }

        .eval-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 15px;
            font-size: 14px;
            color: #475569;
        }

        .eval-text {
            flex: 1;
        }

        .eval-options {
            display: flex;
            gap: 20px;
            justify-content: flex-end;
        }

        .eval-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #334155;
            font-weight: 500;
        }

        .eval-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--visit-green);
            cursor: pointer;
        }

        /* Bottom Textareas */
        .dv-textarea {
            width: 100%;
            min-height: 80px;
            border: none;
            resize: none;
            outline: none;
            font-family: inherit;
            font-size: 15px;
            color: var(--visit-text);
            background-image: linear-gradient(transparent, transparent 29px, #e5e7eb 29px, #e5e7eb 30px);
            background-size: 100% 30px;
            line-height: 30px;
            padding: 0 10px;
        }

        /* Signatures Area */
        .signatures-area {
            display: flex;
            justify-content: space-between;
            padding: 10px 60px 10px 60px;
            margin-top: 5px;
            page-break-inside: avoid;
        }

        .sig-block {
            text-align: center;
            width: 250px;
        }

        .sig-title {
            font-size: 15px;
            font-weight: 800;
            color: var(--visit-text);
            margin-bottom: 10px;
        }

        .sig-input input {
            text-align: center;
            border: none;
            font-weight: 700;
            font-size: 16px;
            color: var(--visit-text);
            padding: 4px;
            width: 100%;
            outline: none;
            background: transparent;
        }
    </style>
</head>

<body>
    <div class="sheet">
        <div id="appHeader"></div>
        <div class="sheet-content" style="padding-top: 20px;">

            <div class="visit-container">

                <div class="visit-main-title">
                    استمارة الزيارات التبادلية
                </div>

                <!-- Row 1: Teachers -->
                <div class="dv-row">
                    <div class="dv-col">
                        <div class="dv-col-title">اسم المعلم الزائر:</div>
                        <input type="text" id="visitingTeacher" class="dv-input" data-save="1" placeholder="اسم المعلم">
                    </div>
                    <div class="dv-col">
                        <div class="dv-col-title">اسم المعلم المزار:</div>
                        <input type="text" id="visitedTeacher" class="dv-input" data-save="1" placeholder="اسم المعلم">
                    </div>
                </div>

                <!-- Row 2: Date, Class, Term -->
                <div class="dv-row">
                    <!-- Date Picker custom logic -->
                    <div class="dv-col" style="padding: 10px; min-height: 60px;">
                        <div class="dv-col-title">اليوم / التاريخ:</div>
                        <div
                            style="position: relative; width: 100%; display: flex; align-items: center; justify-content: center; height: 100%;">
                            <!-- Calendar Icon -->
                            <svg style="width: 18px; height: 18px; color: var(--visit-text); position: absolute; left: 15px; pointer-events: none;"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <!-- Visual Input displaying day + YYYY/MM/DD -->
                            <input type="text" id="visitDateVisual" class="dv-input" placeholder="yyyy/mm/dd" readonly
                                style="cursor: pointer; padding-left: 30px;">
                            <!-- Hidden HTML5 picker handling native picking-->
                            <input type="date" id="visitDate" data-save="1"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                        </div>
                    </div>
                    <div class="dv-col" style="padding: 5px 10px; min-height: 60px; flex: 1.2;">
                        <div class="dv-col-title">الصف / الفصل:</div>
                        <div
                            style="display: flex; align-items: center; justify-content: center; width: 100%; gap: 10px; margin-top: 5px;">
                            <select id="visitClass" class="dv-select" data-save="1" dir="rtl" style="flex: 2;">
                                <option value="" disabled selected>الصف</option>
                                <option value="الأول متوسط">الأول متوسط</option>
                                <option value="الثاني متوسط">الثاني متوسط</option>
                                <option value="الثالث متوسط">الثالث متوسط</option>
                            </select>
                            <span style="font-size: 16px; font-weight: bold; color: var(--visit-text);">/</span>
                            <select id="visitSection" class="dv-select" data-save="1" dir="rtl" style="flex: 1;">
                                <option value="" disabled selected>الفصل</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                    <div class="dv-col" style="min-height: 60px; flex: 0.8;">
                        <div class="dv-col-title">الفصل الدراسي:</div>
                        <div class="dv-select-wrapper" style="margin-top: 5px;">
                            <select id="visitTerm" class="dv-select" data-save="1" dir="rtl">
                                <option value="" disabled selected>اختر الفصل</option>
                                <option value="الأول">الأول</option>
                                <option value="الثاني">الثاني</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Subject & Unit -->
                <div class="dv-row">
                    <div class="dv-col" style="flex: 0.4;">
                        <div class="dv-col-title">المادة:</div>
                        <input type="text" id="visitSubject" class="dv-input" data-save="1" placeholder="مادة">
                    </div>
                    <div class="dv-col" style="flex: 0.6;">
                        <div class="dv-col-title">الوحدة / عنوان الدرس:</div>
                        <input type="text" id="visitLesson" class="dv-input" data-save="1" placeholder="عنوان الدرس">
                    </div>
                </div>

                <!-- Evaluation Table -->
                <div class="dv-box">
                    <div class="dv-box-title">عناصر التقويم</div>

                    <!-- Section 1 -->
                    <div class="eval-section">
                        <div class="eval-title">التخطيط للحصة:</div>
                        <div class="eval-item">
                            <div class="eval-text">الأهداف واضحة ومحددة ومعلنة للطلاب.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval1_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval1_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval1_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-text">المحتوى مناسب للمرحلة ومرتبط بخبرات الطلاب.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval2_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval2_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval2_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2 -->
                    <div class="eval-section">
                        <div class="eval-title">أساليب التدريس:</div>
                        <div class="eval-item">
                            <div class="eval-text">تنوع الاستراتيجيات المستخدمة.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval3_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval3_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval3_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-text">إشراك جميع الطلاب وتوزيع الفرص.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval4_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval4_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval4_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3 -->
                    <div class="eval-section">
                        <div class="eval-title">إدارة الصف:</div>
                        <div class="eval-item">
                            <div class="eval-text">الانضباط الصفي والتحفيز الإيجابي.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval5_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval5_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval5_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-text">استخدام الوسائل التعليمية بفعالية.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval6_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval6_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval6_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4 -->
                    <div class="eval-section">
                        <div class="eval-title">التقويم:</div>
                        <div class="eval-item">
                            <div class="eval-text">وجود تقويم قبلي / بنائي / ختامي.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval7_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval7_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval7_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-text">توظيف نتائج التقويم الفوري خلال الدرس.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval8_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval8_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval8_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5 -->
                    <div class="eval-section">
                        <div class="eval-title">أثر التعلُّم:</div>
                        <div class="eval-item">
                            <div class="eval-text">تقبل المعلم لمشاركات الطلاب.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval9_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval9_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval9_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                        <div class="eval-item">
                            <div class="eval-text">وضوح أثر التعلم على الطلاب.</div>
                            <div class="eval-options">
                                <label class="eval-checkbox"><input type="checkbox" id="eval10_1" data-save="1">
                                    متحقق</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval10_2" data-save="1"> متحقق
                                    جزئياً</label>
                                <label class="eval-checkbox"><input type="checkbox" id="eval10_3" data-save="1"> غير
                                    متحقق</label>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Bottom Textareas Row -->
                <div class="dv-row">
                    <div class="dv-col" style="align-items: stretch;">
                        <div class="dv-col-title">نقاط تميز أداء المعلم/ة المزور/ة:</div>
                        <textarea id="visitStrengths" class="dv-textarea" data-save="1"></textarea>
                    </div>
                    <div class="dv-col" style="align-items: stretch;">
                        <div class="dv-col-title">التوصيات:</div>
                        <textarea id="visitRecommendations" class="dv-textarea" data-save="1"></textarea>
                    </div>
                </div>

                <!-- Signatures -->
                <div class="signatures-area">
                    <div class="sig-block">
                        <div class="sig-title">المعلم</div>
                        <div class="sig-input">
                            <input type="text" id="sigTeacher" data-save="1" placeholder="اسم المعلم">
                        </div>
                    </div>
                    <div class="sig-block">
                        <div class="sig-title">مدير المدرسة</div>
                        <div class="sig-input">
                            <input type="text" id="sigManager" data-save="1" value="عابد عبيد الجدعاني">
                            <div style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">(قابل للتحرير)</div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
        <div id="appFooter"></div>
    </div>

    <!-- Mutually exclusive checkboxes & Date logic -->
    <script>
        window.currentPageKey = 'storage_peer_visit_v1';

        const dateInp = document.getElementById('visitDate');
        const visInp = document.getElementById('visitDateVisual');
        const daysArr = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];

        function updateDateVisual() {
            if (dateInp && dateInp.value) {
                const d = new Date(dateInp.value);
                if (!isNaN(d)) {
                    const dayName = daysArr[d.getDay()];
                    const yyyy = d.getFullYear();
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    // Format matching user request: yyyy/mm/dd + day name
                    visInp.value = `${dayName} ${yyyy}/${mm}/${dd}`;
                }
            } else if (visInp) {
                visInp.value = '';
            }
        }

        if (dateInp) {
            dateInp.addEventListener('change', () => {
                updateDateVisual();
                if (window.appStorage && window.appStorage.savePage) {
                    window.appStorage.savePage(window.currentPageKey);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Restore from storage
            window.appStorage.restorePage(window.currentPageKey, (data) => {
                // Ensure text date parses correctly once restored
                updateDateVisual();
            });
            window.appStorage.setupAutoSave(window.currentPageKey);

            // Setup mutually exclusive checkboxes logic for each eval row
            const rows = 10;
            for (let i = 1; i <= rows; i++) {
                const cb1 = document.getElementById(`eval${i}_1`);
                const cb2 = document.getElementById(`eval${i}_2`);
                const cb3 = document.getElementById(`eval${i}_3`);

                if (!cb1 || !cb2 || !cb3) continue;

                const group = [cb1, cb2, cb3];

                group.forEach(cb => {
                    cb.addEventListener('change', function () {
                        if (this.checked) {
                            // uncheck others
                            group.forEach(other => {
                                if (other !== this) other.checked = false;
                            });
                        }
                        if (window.appStorage && window.appStorage.savePage) {
                            window.appStorage.savePage(window.currentPageKey);
                        }
                    });
                });
            }
        });
    </script>
</body>

</html>